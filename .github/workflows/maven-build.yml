name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    permissions: write-all
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: '8'
        distribution: 'corretto'
        cache: maven
    
    - name: Build with Maven
      run: mvn -B package --file pom.xml
    
    - name: 🧪✅❌ Publish Test Report
      id: test_results
      uses: dorny/test-reporter@v1.8.0
      if: always()
      with:
        name: 🧪📊 Unit tests report
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: true

    - name: Create Test Results Badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      if: always()
      with:
        auth: ${{ secrets.GIST_TOKEN }}
        gistID: "1adc6e2e2a100187949bb9fcec235421"
        filename: "PermuteMMOFilter-junit.json"
        style: 'plastic'
        namedLogo: 'junit5'
        label: 'Tests'
        labelColor: '#3d454d'
        message: "${{ steps.test_results.outputs.passed }} passed${{ steps.test_results.outputs.failed > 0 && format(', {0} failed', steps.test_results.outputs.failed) || ''}}${{ steps.test_results.outputs.skipped > 0 && format(', {0} skipped') || ''}}"
        color: ${{ steps.test_results.outputs.conclusion == 'success' && '#32c955' || 'red' }}
     
    - name: Create Test Results Redirect Html
      uses: gorgbus/gist-actions@1.0.0
      if: always()
      env:
        GITHUB_TOKEN: ${{ secrets.GIST_TOKEN }}
      with:
        action: "update"
        gist_id: "b2e4dd221203a0d004c7d060849d3e43"
        file_name: "PermuteMMOFilter-junit-redirect.html"
        content: '<html><head><meta http-equiv="refresh" content="0; URL=${{steps.test_results.outputs.url_html}}"</head></html>'
        
